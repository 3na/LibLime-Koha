<!-- TMPL_INCLUDE NAME="doc-head-open.inc" -->
<title>Koha &rsaquo; Circulation &rsaquo; Holds &rsaquo; Edit holds on <!-- TMPL_VAR NAME="title" escape="html" --></title>
<!-- TMPL_INCLUDE NAME="doc-head-close-plack.inc" -->
<style>
tr.hilight td {
   background-color: #ffffcc;
}
#simplemodal-container a.modalCloseImg {
   background:url(<TMPL_VAR NAME="themelang">/img/x.png) no-repeat;
   width:25px;
   height:29px;
   display:inline;
   z-index:3200;
   position:absolute;
   top:-15px;
   right:-18px;
   cursor:pointer;
}
</style>
<script type="text/javascript" src="<!-- TMPL_VAR name="themelang" -->/js/dates.js"></script>
<!-- TMPL_INCLUDE NAME="calendar.inc" -->
<script>
$.ajaxSetup({accepts:'application/json',dataType:'json',beforeSend:function(xhr){xhr.setRequestHeader('Accept','application/json')}});
var mydb     = '<TMPL_VAR NAME="SessionStorage">';
var batchres = new Array;
var branches = new Array;
var reserves = new Array;
var savingModal;

function chMode() {
   var mymode = 'batch';
   if (mymode=='batch') {
//   if($('#mode').val()=='batch'){ 
      $('#update').html('<input type=button value="Update Holds" onclick="updateHolds()">'); }
   else                         { $('#update').html('') }
}
jQuery.fn.sortAll = function() {
   var p   = 'int:priority';
   if (document.myf.sortf) { p = $('#sortf').val(); if(p=='' || !p){ p='int:priority' } }
   else if ('<TMPL_VAR NAME="sortf">' != '') { p = '<TMPL_VAR NAME="sortf">' }
   var arr = p.split(/:/); var type=arr[0]; var sortf=arr[1];
   var reverse = false;
   if (document.myf.sortRev) { reverse = ($('select#sortRev').val()=='ASC')? true:false; }
   else if ('<TMPL_VAR NAME="sortRev">'=='ASC') { reverse = true }
   this.sort(function(a,b){
      var left = a[sortf]; var right=b[sortf];
      if (type=='int') { left=parseInt(left.replace(/[^\d]/g,''));right=parseInt(right.replace(/[^\d]/g,'')); }
      else             { left=left.toLowerCase()       ;right=right.toLowerCase();        }
      if(reverse) { l=left; r=right; left=r; right=l; }
      if(left < right) { return -1 }
      if(left > right) { return  1 }
      return 0;
   });
   return this;
};
function getInit(limit) { 
   batchres = new Array;
   document.myf.sofar.value = 0;
   $.ajax({
      url: '/reserves/?biblionumber=<TMPL_VAR NAME="biblionumber">&inflate=1',
      async: false,
      error: function(xhr,rc,thrown) {
         _err(rc)
      },
      success: function(all) {
         if(all.length > 0) {
            reserves = $(all).sortAll();
            pager(reserves,parseInt(document.myf.pg.value));
            chMode('batch');
         }
         else {
            $('#existingReserves').append('<tr><td colspan=8>There are no holds - '
             +'<a href="placehold.pl?biblionumber=<TMPL_VAR NAME="biblionumber">">Place a hold</a></td></tr>');
         }
      },
      statusCode: {
         403: function(xhr,rc) { _err(rc) },
         404: function(xhr,rc) { _err(rc) }
      }
   });

} //eof getInit

function modPriority(sel,onshelf,reservenumber,limit) {
   if (onshelf != 0) {
      var msg  = 'This item is currently ';
      var tog  = 0;
      var rank = (onshelf==1)? 'W':'T';
      if      (onshelf==1) { msg += 'on the holds shelf.\n'; }
      else if (onshelf==2) { msg += 'in transit.\n';         }
      if ((sel.selectedIndex + 1) == sel.options.length) {
         msg += 'Are you sure you want to cancel this hold?';
         tog  = 1;
      }
      else if (sel.selectedIndex != sel.options.length-2) {
         msg += 'Are you sure you want to requeue this hold?';
         tog = 1;
      }
      if (tog) {
         var ans = confirm(msg);
         if (ans) {}
         else {
            var el = document.getElementById('rank_'+reservenumber);
            for(var i=0;i<sel.options.length;i++) {
               if(sel.options[i].value == rank) {
                  el.selectedIndex = i;
                  break;
               }
            }
            return;
         }
      }
   }
   modRes(reservenumber,limit);
} //eof modPriority()

function modRes(reservenumber,limit) {
   var add  = 1;
   var rank = $('#rank_'+reservenumber).val();
   var pick = $('#pick_'+reservenumber).val();
   var resd = $('#resume_'+reservenumber).val();
   if(resd.length>0) {
      var el = document.getElementById('susp_'+reservenumber);
      el.checked = true;
   }
   var isSp = ($('#susp_'+reservenumber).is(':checked')==true)? 1:0;
   if (isSp==0) { resd=null }

   for(var i=0;i<batchres.length;i++) {
      if(batchres[i][0]==reservenumber){
         batchres[i] = [reservenumber,rank,pick,isSp,resd];
         add = 0;
         break;
      }
   }      
   if (add==1) {
      batchres.push([reservenumber,rank,pick,isSp,resd]);
   }
   var trclass = 'hilight';
   if (rank=='del') { trclass = 'confirm' }
   $('#tr_'+reservenumber).attr('class',trclass);
}

function _err(rc) {
   return $('#existingReserves').append('<tr><td colspan=8><span class=problem>'+rc+'</span></td></tr>');
}
function showReserve(res,allLen,c) {
            var details      = '';
            var listPriority = '';
            var listPick     = '';
            var suspended    = '';
            var onshelf      = 0;
            var mas          = '';
            var setcal       = 0;
            for(var i=0;i<batchres.length;i++) {
               if(batchres[i][0]==res.reservenumber) {
                  if      (batchres[i][1]=='W') { res.priority=''; res.found='W' }
                  else if (batchres[i][1]=='T') { res.priority=''; res.found='T' }
                  else                          { res.priority=batchres[i][1];   }
                  res.branchcode = batchres[i][2];
                  res.found      = batchres[i][3]? 'S':'';
                  break;
               }
            }

            var branchname = res.branchname;
            if (res.reservenotes==null) { res.reservenotes = ''; }
            for(var i=1;i<=allLen;i++) {
               var ch = '';
               if (i==res.priority) { ch = ' selected'; }
               listPriority += '<option '+ch+'>'+i;
            }
            if (res.found=='W') {
               listPriority += '<option value="W" selected>Waiting';
               onshelf       = 1;
               mas           = 'Waiting since<br>'+ts2date(res.waitingdate,dformat);
               listPick      = 'Item waiting at<br><b>'+branchname+'</b>';
//               suspended     = '<input type=checkbox disabled>';
            }
            else if (res.found=='T') {
               onshelf       = 2;
               listPriority += '<option value="T" selected>In Transit';
               listPick      = 'Waiting to be pulled at<br>'+branchname;
//               suspended     = '<input type=checkbox disabled>';
            }
            else {
               var isSuspended = res.found=='S'?true:false;
               suspended = '<input type=checkbox name="susp_'+res.reservenumber+'" '+(isSuspended?'checked':'')+' id="susp_'+res.reservenumber+'" onclick="$(\'#resume_'+res.reservenumber+'\').val(\'\');modRes('+res.reservenumber+','+c+')" value=1>';
               listPick = '<select name="pick_'+res.reservenumber+'" id="pick_'+res.reservenumber+'" onchange="modRes('+res.reservenumber+','+c+')">';
               for(var i=0;i<branches.length;i++) {
                  listPick += '<option value="'+branches[i][0]+'" '+(res.branchcode==branches[i][0]?'selected': '')+'>'+branches[i][1];
               }
               listPick += '</select>';
               var resumedate = '';
               if (res.waitingdate) { resumedate = ts2date(res.waitingdate,dformat) }
               mas ='resume on (optional)<br>'+
               '<input type=text name="resume_'+res.reservenumber+'" size=10 maxlength=10 '+
               'id="resume_'+res.reservenumber+'" value="'+resumedate+'" id="resume_'+res.reservenumber+'">';
               setcal = 1;
            }
            listPriority += '<option value="del">cancel';
            if (res.itemnumber) {
               if (res.priority==0) { details = 'only item<br>'; }
               details += '<a href="/cgi-bin/koha/catalogue/moredetail.pl?biblionumber='+res.biblionumber+'&itemnumber='+res.itemnumber+'#item'+res.itemnumber+'">'+res.itembarcode+'</a>';
            }
            else {
               details = '<i>Next available</i>';
            }

            $('#existingReserves > tbody:last').append('<tr id="tr_'
               +res.reservenumber         +'"><td><select id="rank_'
               +res.reservenumber         + '" onchange="modPriority(this,'
               +onshelf                   +','+res.reservenumber+','+c+')">'
               +listPriority              +'</select></td><td><a href="/cgi-bin/koha/circ/circulation.pl?borrowernumber='
               +res.borrowernumber        +'">'+res.borrowername+'</a><br><a href="/cgi-bin/koha/members/moremember.pl?borrowernumber='
               +res.borrowernumber        +'">'+res.borrowercard+'</a></td><td>'
               +res.reservenotes          +'</td><td>' + ts2date(res.reservedate,dformat) +'</td><td nowrap>'
               +listPick                  +'</td><td>'
               +details                   +'</td><td align=center>'
               +suspended                 +'</td><td nowrap>'
               +mas                       +'</td></tr>');
            if(setcal==1) {
               Calendar.setup({
                     inputField: "resume_"+res.reservenumber,
                     ifFormat  : "<TMPL_VAR NAME="DHTMLcalendar_dateformat">",
                     button    : "resume_"+res.reservenumber,
                     align     : "T1",
                     onClose   : function() { 
                        calendar.hide();
                        modRes(res.reservenumber,c);
                     }
               });
            }

   var trclass = 'hilight';
   for(var i=0;i<batchres.length;i++) {
      if(batchres[i][0]==res.reservenumber) {
         if (batchres[i][1]=='del') { trclass = 'confirm' }
         $('#tr_'+res.reservenumber).attr('class',trclass);
      }
   }
} //eof showReserve

function updateHolds() {
   if (savingModal) { savingModal.close(); }
   if (batchres.length==0) { alert('Nothing to update'); return }
   savingModal = $('#saving').modal();
   for(var i=0;i<batchres.length;i++) {
      var reservenumber = batchres[i][0];
      var rank = batchres[i][1];
      var pick = batchres[i][2];
      var susp = batchres[i][3];
      var resd = batchres[i][4];
      var myfound;
      var mywaitingdate;
      if(susp==1) { 
         myfound = 'S';
         if (resd != '') { mywaitingdate = dformat2db(resd,dformat,mydb); }
      }
      var method = 'POST';
      if (rank=='del') { method = 'DELETE' }
      $.ajax({
         url :'/reserves/'+reservenumber,
         type: method,
         async: true,
         data: {
            priority    :rank,
            branchcode  :pick,
            found       :myfound,
            is_suspended:susp,
            resume_date :mywaitingdate
         },
         success: function() {
            var mysofar = parseInt(document.myf.sofar.value);
            mysofar += 1;
            document.myf.sofar.value = mysofar;
            if(mysofar==batchres.length) {
               savingModal.close();
               getInit(10);
            }
         }
      });
   }
} //eof updateHolds()

function pager(all,pg) {
   if(!pg || pg==null || pg==undefined || pg==0) { pg = 1 }
   document.myf.pg.value = pg;
   var limit  = 10;
   var offset = (pg-1)*10; if(offset>all.length) { offset=all.length }
   var from   = offset+1;
   var to     = limit+offset; if (to>all.length) { to=all.length }
   var first  = ''; var last = '';
   var nPg    = ''; var next = '';    
   var pPg    = ''; var prev = '';
   var pgs    = 1;  var omni = ''; // TODO: omni=View All
   if (all.length%10 > 0) { pgs = parseInt(all.length/10)+1 }
   else                   { pgs = all.length/10             }
   if (limit<all.length)  { nPg = pg+1 } if (nPg>pgs) { nPg = 0 }
   if (pg != 1)           { pPg = pg-1 } if (pPg<1)   { pPg = 0 }
   var curr = ' Page <b>'+pg+'</b> of '+pgs;
   if (nPg!='') { next = ' .. <a href="javascript:;" onclick="document.myf.pg.value='+nPg+';pager(reserves,'+nPg+');">Next <b>&gt;</b></a> '; }
   if (pPg!='') { prev = '<a href="javascript:;" onclick="pager(reserves,'+pPg+');"><b>&lt;</b> Prev</a> .. '; }
   if (pg>1)    { first= '<a href="javascript:;" onclick="pager(reserves,1);"><b>&lt;&lt;</b> First</a> ' }
   if (pg<pgs)  { last = '<a href="javascript:;" onclick="pager(reserves,'+pgs+');">Last <b>&gt;&gt;</b>' }
   var sorter  = 'Sort by';
   var sortOps = '';
   var dirOps  = '';
   var dirArr  = new Array('ASC','DESC');
   var sortArr = new Array(
      ['int:priority',     'Priority'        ],
      ['str:borrowername', 'Patron Name'     ],
      ['int:reservedate',  'Date'            ],
      ['str:branchname',   'Pickup Library'  ]
   );
   for(var i=0;i<sortArr.length;i++) {
      var sel = '';
      if(document.myf.sortf) {
         if (document.myf.sortf.selectedIndex==i) { sel = ' selected' }
      }
      else if (sortArr[i][0]=='<TMPL_VAR NAME="sortf">') { sel = ' selected' }
      sortOps += '<option value="'+sortArr[i][0]+'"'+sel+'>'+sortArr[i][1]+'</option>';
   }
   for(var i=0;i<dirArr.length;i++) {
      var sel = '';
      if(document.myf.sortRev) {
         if (document.myf.sortRev.selectedIndex==i) { sel = ' selected' }
      }
      else if (dirArr[i]=='<TMPL_VAR NAME="sortRev">') { sel = ' selected' }
      dirOps += '<option'+sel+'>'+dirArr[i];
   }
   sorter+= '<select name="sortf" id="sortf" onchange="reserves=reserves.sortAll();pager(reserves,'+pg+');">'+sortOps+'</select>'
          + '<select name="sortRev" id="sortRev" onchange="reserves=reserves.sortAll();pager(reserves,'+pg+');">'+dirOps+'</select>';
   $('#pager1').html(sorter);
   $('#pager2').html('Showing '+from+' to '+to+' of '+all.length+' rows | ' +first+prev+curr+next+last);
   $('#existingReserves > :not(thead) > tr').remove();

   var c = 0;
   for(var i=offset;i<limit+offset;i++) {
      if(all[i]) { showReserve(all[i],all.length,c); c++; }
   }
}
$(document).ready(function() {
   $.ajax({
      url:'/branches/',
      success: function(data) {
         $.each(data, function(idx,br) {
            branches.push([br.branchcode,br.branchname]);
         });
         getInit(<TMPL_VAR NAME="limit">);
      }
   });
});
</script>
</head>
<body>
<!-- TMPL_INCLUDE NAME="header.inc" -->
<!-- TMPL_INCLUDE NAME="circ-search-plack.inc" -->

<div id="breadcrumbs"><a href="/cgi-bin/koha/mainpage.pl">Home</a> &rsaquo; <a href="/cgi-bin/koha/catalogue/search.pl">Catalog</a> &rsaquo; <a href="/cgi-bin/koha/catalogue/detail.pl?biblionumber=<!-- TMPL_VAR NAME="biblionumber" -->"><!-- TMPL_VAR NAME="title" escape="html" --></a> &rsaquo; Edit holds</div>

<div id="doc3" class="yui-t2">
<div id="bd">
	<div id="yui-main">
	<div class="yui-b">
      <form name="myf" id="myf">
      <input type=hidden name="limit"  value="<TMPL_VAR NAME="limit">">
      <input type=hidden name="pg"     value="<TMPL_VAR NAME="pg">" id="pg">
      <input type=hidden name="sofar"  value="0">
      <table class=borderless width="100%">
      <tr class=borderless>
         <td class=borderless><h3>Edit holds on <a href="/cgi-bin/koha/catalogue/detail.pl?biblionumber=<!-- TMPL_VAR NAME="biblionumber" -->"><!-- TMPL_VAR NAME="title" escape="html" --></a></h3></td>
         <td class=borderless align=right id="pager1" nowrap></td></tr>
      <tr class=borderless><td class=borderless colspan=2>
      <table id="existingReserves" width="100%">
      <tbody>
      <thead><tr>
         <th>Priority</th>
         <th>Patron</th>
         <th>Notes</th>
         <th>Date</th>
         <th>Pickup Library</th>
         <th>Details</th>
         <th>Suspended</th>
         <th>Waiting/<br>Resume</th></tr>
      </thead>
      </tbody>
      </table>
      </td></tr>
      <tr class=borderless>
         <td class=borderless id="update"></td>
         <td class=borderless align=right id="pager2"></td>
      </tr></table>
      </form>
   </div><!-- eof yui-b -->
   </div><!-- eof yui-main -->

   <div class="yui-b">
   <!-- TMPL_INCLUDE NAME="biblio-view-menu.inc" -->
   </div>
</div><!-- eof bd -->
<div id="saving" style="border:double 4px #000;background-color:#ffffcc;opacity:100;padding:6px;display:none"><img 
src="/intranet-tmpl/prog/img/loading-trans.gif" align=abscenter>Saving... &nbsp; &nbsp; &nbsp;
</div>
<script>
function setCal(reservenumber,limit) {
}
</script>
<!-- TMPL_INCLUDE NAME="intranet-bottom.inc" -->
